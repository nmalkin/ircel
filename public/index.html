<!doctype html>
<meta charset=utf-8>
<link rel=stylesheet href='./screen.css'>
<title> Irc Client </title>

<div id=tabs><button id=newtab>+</button></div>
<div id=flux></div>

<form action='javascript:triggerListen()' id=controls>
  <input id=msg>
</form>

<!-- hidden elements (for duplication) -->
<div class='hidden'>
  <span id='tab'></span>
  <div id=content>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  // Contents.

  var contents = [];

  function addContent() {
  }

  function switchToContent(index) {
  }


  // Tabs are here.
  function addTab(tabName, index) {
    index = index || 0;
    var newTab = tab.cloneNode();
    newTab.removeAttribute('id');
    newTab.setAttribute('class', 'tab');
    newTab.textContent = tabName;
    var children = tabs.childNodes;
    var chosenIndex = index;
    if (index >= children.length) {
      chosenIndex = children.length - 1;
    }
    newTab.onclick = function () {
      selectTab(chosenIndex);
    };
    tabs.insertBefore(newTab, children[chosenIndex]);
    return index;
  }

  function selectTab(index) {
    var children = tabs.childNodes;
    children[index].className = 'tab selected';
    if (currentCtx !== null) {
      children[currentCtx.index].className = 'tab';
    }
    currentCtx = getCtx(index);
    switchToContent(index);
  }

  var contexts = [];
  var currentCtx = null;

  function getCtx(index) {
    for (var i = 0; i < contexts.length; i++) {
      if (contexts[i].index === index) {
        return contexts[i];
      }
    }
    return null;
  }

  function Context(name, type) {
    if (!(this instanceof Context)) return new Context(name, type);
    this.type = type || '';
    this.name = name;

    contexts.push(this);
    this.index = addTab(name, contexts.length - 1);
    selectTab(this.index);
  }

  // A message is:
  // {
  //   type: 'say'
  // }
  Context.prototype.send = function(msg) {

  };


  // Listen.

  var listeners = [];
  function triggerListen() {
    for (var i = 0; i < listeners.length; i++) {
      listeners[i](msg.value, currentCtx);
    }
  }

  function listen(cb) {
    listeners.push(cb);
  }

  onload = function () {
    Context('login');
    Context('room');
    selectTab(1);
    Context('more');
  };


  //API
  window.addTab = addTab;
  window.selectTab = selectTab;
  window.listen = listen;
  window.Context = Context;
</script>
